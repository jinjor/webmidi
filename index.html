<html ng-app="brouserSynth">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
  <title>WebMidiLink Sample</title>
  <script src="/socket.io/socket.io.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
  <script type="text/javascript" src="/js/angular.min.js"></script>
  <script type="text/javascript" src="/js/underscore-min.js"></script>
  <script type="text/javascript" src="/js/jazz-plugin-handler.js"></script>
  <script type="text/javascript" src="/js/footerFixed.js"></script>
  <script type="text/javascript" src="/js/webmidi.js"></script>
  

    
  <link rel="stylesheet" type="text/css" href="/css/base.css"/>
  <script type="text/javascript">
    
  var SmfFile = org.jinjor.smf.SmfFile;
  var SynthDef = org.jinjor.synth.SynthDef;
  var RecState = org.jinjor.webmidi.RecState;
  var Track = org.jinjor.webmidi.Track;
  var Tune = org.jinjor.webmidi.Tune;
  var Sequencer = org.jinjor.webmidi.Sequencer;
  var TuneEditView = org.jinjor.webmidi.views.HtmlTuneEditView;
  var AngularTuneDao = org.jinjor.webmidi.daos.AngularTuneDao;
  var AngularUserDao = org.jinjor.webmidi.daos.AngularUserDao;
  var AngularTuneEditController = org.jinjor.webmidi.controllers.AngularTuneEditController;

  var module = angular.module('brouserSynth', []);
  JazzPlugin.attachTo(module);
  var id = 0;
  module.factory('Synth', function($rootScope) {
    var Synth = function(name, url, author, programs){
      this.id = name;
      this.name = name;
      this.url = url;
      this.author = author;
      this.programs = programs;
      this.sy = null;
    };
    Synth.prototype.load = function(frame) {
      frame.location.href = this.url;
      this.sy = frame;
    };
    Synth.prototype.noteOn = function(note, velo) {
      this.sendMessage("midi,90," + note.toString(16) + "," + velo.toString(16));
    };
    Synth.prototype.noteOff = function(note) {
      this.sendMessage("midi,80," + note.toString(16) + ",0");
    };
    Synth.prototype.allSoundOff = function() {
      this.sendMessage("midi,b0,78,0");
    };
    Synth.prototype.sendMidiMessage = function(m0, m1, m2) {
      this.sendMessage('midi,' + m0.toString(16) +','+ m1.toString(16)+','+ (m2 ? m2.toString(16) : "0"));
    };
    Synth.prototype.sendMessage = function(s) {
      if(this.sy){
        //console.log(s);
        this.sy.postMessage(s, "*");
      }  
    };
    Synth.prototype.programsAsArray = function(){
      return _.values(this.programs);
    };
    return Synth;
  });
  module.directive('wmcanvas', function() {
    return {
      restrict: 'A',
      link: function(scope, elm, attrs) {
        setTimeout(function(){
          scope.refreshView();
        },0);
        
        var duration = 300;
        elm = $(elm);
        elm.hide();
        elm.fadeIn(duration);
        
        scope.destroy = function(complete) {
          elm.fadeOut(duration, function() {
            if (complete) {
              complete.apply(scope);
              setTimeout(function(){
                scope.refreshView();
              },0);
            }
          });
        };
      }
    };
  });

  function KeyboardCtrl($scope, $http, Synth, jazz) {
  
    var view = new TuneEditView(document, $scope);
    
    var tuneDao = new AngularTuneDao($http);
    var userDao = new AngularUserDao($http);
    $scope.refreshView = function(){// implements directive
      console.log('refreshView');
      view.refresh();
      view.renderAll();
    };
    $scope.address = location.href.split('/tunes/', 2)[1];
    document.title = $scope.address + " - WebMidiLink Sample";
    $scope.showFrame = false;
    $scope.connection = 'disconnected';
    $scope.echoms = '';
    $scope.user = null;
    
    userDao.get(function(e, user){//非同期１
      if(e){
        alert(e);
      }else{
        $scope.user = user;
      } 
    });
    
    $scope.synthDefs = SynthDef.synthDefs;
    $scope.synths = {};
    _(SynthDef.synthDefs).each(function(synthDef){
      $scope.synths[synthDef.name] = new Synth(synthDef.name, synthDef.url, synthDef.author, synthDef.programs);
    });
    $scope.synthsAsArray = function(){
      return _.values($scope.synths);
    };
    
    $scope.channels = [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16];


    
    jazz.onMessage(function(t, m0, m1, m2){
      if(m0 == 248){
        //$scope.sequencer.send(t, m0, m1, m2);
      }else{
        $scope.$apply(function() {
          $scope.sequencer.send(t, m0, m1, m2);
        });
      }
    });
    
    $(document).ready(function(){
      var controller = new AngularTuneEditController($scope);
      
      $scope.saveContents = function(){
        tuneDao.save($scope.sequencer.tune, $scope.address, function(e){
          if(e){
            alert(e)
          }else{
            alert('saveしました');
          }
        });
      };
      
      $scope.selectTrack = function(track){
        $scope.sequencer.tune.selectedTrackId = track.id;
      };
      $scope.trackIsSelected = function(track){
        return $scope.sequencer.tune.trackIsSelected(track) ? 'selected' : null;
      };
        
      $scope.messages = [];
      $scope.keyIsPressed = function(track){
        return ($scope.sequencer.tune.trackIsSelected(track) &&
                $scope.sequencer.recState &&
                $scope.sequencer.recState.keyIsPressed()) ? 'pressed' : '';
      };
      $scope.play = function(){
        controller.play(view);
      };
      $scope.rec = function(){
        controller.rec(view);
      };
      $scope.stop = function(){
        $scope.sequencer.stopPlaying(function(){
          view.renderAll();
        });
        view.renderAll();
      };
      $scope.gainPxPerMs = function(amount){
        $scope.sequencer.gainPxPerMs(amount);
        view.renderAll();
      };
      $scope.addTrack = function(synthDef){
        $scope.sequencer.tune.addTrack(synthDef, 1);
      };
    
    
      _($scope.synths).each(function(synth){
        synth.load(document[synth.id]);
      });
      tuneDao.get($scope.address, function(e, tracks) {//非同期２
        if(e){
          alert(e);
        }else{
          tracks = tracks || [];
          var tune = new Tune();
          tune.replaceTracksByLoadedTracks(tracks, $scope.synths);
          var synthMap = {};
          $scope.sequencer = new Sequencer(tune, function(synthDef){
            return synthMap[synthDef.name]
          });
          _($scope.synths).each(function(synth){
            //synth.load(document[synth.id]);
            synthMap[synth.id] = synth;
          });
        }
        $scope.ready = true;
      });
    
    
      

      $.event.props.push('dataTransfer');//おまじない
      if (window.File) {
          $("#drop").on("dragover", function(event){
            event.preventDefault();
          }).on("drop", function(event){
            var files = event.dataTransfer.files;
            var f = files[0];
            var smfFile = new SmfFile(f, new FileReader(), function(){
              $scope.sequencer.tune.refresh(smfFile.smfData, SynthDef.GMPlayer);
              $scope.$apply();
              setTimeout(function(){
                createView().renderAll();
              },0);
            });
            event.preventDefault();
          });
      } else {
          window.alert("本ブラウザではFile APIが使えません");
      }
    });
    
    
  }
  </script>

</head>
<body ng-controller="KeyboardCtrl">
  <h1>♪ {{address}}</h1>
  <div ng-show="user">ようこそ {{user}}<a href="/signout/{{address}}">ログアウト</a></div>
  <div ng-show="!user"><a href="/signin/twitter/{{address}}">Twitter認証でログイン</a></div>
  <div id="comment">
    <p>MIDIキーボードからWebMidiLinkで音を鳴らすサンプル（つくりかけ）。<br/>MIDI接続には<a href="http://jazz-soft.net/doc/Jazz-Plugin/" target="blank">JazzPlugin</a>が必要です。<br/></p>
    <ul>
      <li><a href="http://www.g200kg.com/en/docs/webmidilink/" target="blank">WebMidiLinkについて</a>: シンセ作者様のリンクもこちらに<br/></li>
      <li><a href="https://github.com/jinjor/webmidi" target="blank">GitHub</a>: このページのソースです</li>
    </ul>
  </div>
  
  <hr/>
  <!-- Jazz-Plugin -->
  <object id="Jazz1" classid="CLSID:1ACE1618-1C7D-4561-AEE1-34842AA85E90" class="hidden">
    <object id="Jazz2" type="audio/x-jazz" class="hidden">
      <p style="visibility:visible;">This page requires <a href=http://jazz-soft.net>Jazz-Plugin</a> ...</p>
    </object>
  </object>
  
  <div ng-show="ready">
    <div>
      <p>
        <label>MIDI Input:</label>
        <select ng-model="currentMidiIn" ng-change="changeMidiIn(currentMidiIn)" ng-options="midiIn for midiIn in midiIns">
        </select>
      </p>
    </div>
    <button ng-repeat="synthDef in synthDefs" ng-click="addTrack(synthDef)">
      {{synthDef.name}}
    </button>
    
    <div>
      <button ng-click="rec()" ng-disabled="sequencer.isPlaying()">●Rec</button>
      <button ng-click="play()" ng-disabled="sequencer.isPlaying()">Play</button>
      <button ng-click="stop()" ng-disabled="!sequencer.isPlaying()">Stop</button>
    </div>
    <div>
      <button ng-click="gainPxPerMs(-1)" ng-disabled="sequencer.tune.hasMinPxPerMs()">-</button>
      <button ng-click="gainPxPerMs(1)" ng-disabled="sequencer.tune.hasMaxPxPerMs()">+</button>
    </div>
    <div class="tracks">
      <ul>
        <li ng-repeat="track in sequencer.tune.tracks" class='track {{trackIsSelected(track)}}' ng-click="selectTrack(track)" wmcanvas>
          <div class="track_def">
            <!--<label>{{$index + 1}}</label>-->
            <span class="keyboard {{keyIsPressed(track)}}">■</span> <!--{{track.name}} : {{track.synth.name}}-->
            <select ng-model="track.synthDef" ng-change="track.onChangeSynth()" ng-options="synthDef.name for synthDef in synthDefs"></select>
            <label>Ch:</label><select ng-model="track.channel" ng-disabled="false" ng-options="channel for channel in channels"></select>
            <label>Prg:</label><select ng-model="track.program" ng-change="sequencer.programChange(track)" ng-options="(program.number + ':' + program.description) for program in sequencer.getSynth(track.synthDef).programsAsArray()"></select>
            <!--<input type="checkbox" ng-model="track.rec">-->
            <form ng-submit="track.deleteAll()">
              <input type="submit" value="Delete"></input>
            </form>
          </div>
          <div id="pianoroll_summary.{{track.id}}" class="pianoroll_summary">
            <div class="canvas_container">
              <canvas class="layer1" id="{{track.id}}.1" width="1000px" height="128px"></canvas>
              <canvas class="layer2" id="{{track.id}}.2" width="1000px" height="128px"></canvas>
            </div>
          </div>
        </li>
      </ul>
    </div>
    <iframe ng-repeat="synth in synths" ng-show="showFrame" name="{{synth.id}}" width="600px" height="400px" src="iframe.html"></iframe>

    <form ng-submit="saveContents()">
      <input id="" type="submit" value="Save" ng-disabled="!user"></input>
    </form>
    <div id="drop" style="width:700px; height:150px; padding:10px; border:1px solid">
      SMF Import (drag & drop)
    </div>
    
    <a href="https://twitter.com/share" class="twitter-share-button" data-text="{{address}} #WebMidiLink" data-url="http://http://webmidi.herokuapp.com/tunes/{{address}}" data-lang="ja">ツイート</a>
    <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
  </div>

  <footer id="footer">
    <hr/>

    Copyright (C) 2012-2013 Yosuke Torii All Rights Reserved.
  </footer>
  <!--
  <canvas id="jabkencanvas"><canvas>
                              -->
</body>
</html>